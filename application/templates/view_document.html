{% extends "base.html" %}

{% block title %}
    –ü–µ—Ä–µ–≥–ª—è–¥: {{ document.operation_type }} ‚Ññ{{ document.documents_id[:8] }}
{% endblock %}

{% block head %}

{% endblock %}

{% block content %}
    <div class="doc-container">
        <h1>{{ document.operation_type }}</h1>
        
        <div class="nav-links">
            <a href="{{ url_for('documents_list') }}">‚Üê –ù–∞–∑–∞–¥ –¥–æ —Å–ø–∏—Å–∫—É</a>
        </div>
        
        <h2>–ó–∞–≥–æ–ª–æ–≤–æ–∫</h2>
        <div class="header-info">
            <div><strong>ID:</strong> {{ document.documents_id }}</div>
            <div><strong>–î–∞—Ç–∞:</strong> {{ document.document_date.strftime('%Y-%m-%d %H:%M') if document.document_date else '–ù/–î' }}</div>
            <div><strong>–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç:</strong> {{ document.counterparty.counterparty_name if document.counterparty else '–ù–µ–º–∞—î' }}</div>
            <div><strong>–°—É–º–∞ (–±–µ–∑ –ü–î–í):</strong> {{ document.amount }} {{ document.currency }}</div>
        </div>

        <h2>–¢–∞–±–ª–∏—á–Ω–∞ –ß–∞—Å—Ç–∏–Ω–∞ (–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞)</h2>
        <table class="doc-table">
            <thead>
                <tr>
                    <th>‚Ññ</th>
                    <th>–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞</th>
                    <th>–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
                    <th>–û–¥. –≤–∏–º.</th>
                    <th>–¶—ñ–Ω–∞ (–∑ –ü–î–í)</th>
                    <th>–ü–î–í</th>
                    <th>–°—É–º–∞ (–±–µ–∑ –ü–î–í)</th>
                    <th>–°—É–º–∞ (–∑ –ü–î–í)</th>
                </tr>
            </thead>
            <tbody>
                {% set totals = namespace(with_vat=0.0, without_vat=0.0) %}
                
                {% for line in lines %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ line.nomenclature.nomenclature_name if line.nomenclature else '–ù/–î' }}</td>
                    <td>{{ line.quantity }}</td>
                    <td>{{ line.unit | default('—à—Ç') }}</td>
                    <td>{{ line.price_with_vat }}</td>
                    <td>{{ line.vat_amount }}</td> 
                    <td>{{ line.total_amount }}</td>
                    <td>{{ line.total_with_vat }}</td>
                </tr>
                
                {% set totals.with_vat = totals.with_vat + (line.total_with_vat | string | float) %}
                {% set totals.without_vat = totals.without_vat + (line.total_amount | string | float) %}
                
                {% endfor %}
            </tbody>
            <tfoot>
                <tr class="total-row">
                    <td colspan="6" style="text-align: right;">–ó–∞–≥–∞–ª—å–Ω–∞ –°—É–º–∞:</td>
                    
                    <td>{{ "%.2f" | format(totals.without_vat) }}</td> 
                    <td>{{ "%.2f" | format(totals.with_vat) }}</td>
                </tr>
            </tfoot>
        </table>
        <div class="actions-panel" style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 5px; display: flex; justify-content: space-between; align-items: center;">
    
            <div style="display: flex; gap: 10px; align-items: center;">
    
                {# --- –ë–õ–û–ö 1: –ö–ù–û–ü–ö–ò –ü–†–û–í–ï–î–ï–ù–ù–Ø (–õ–Ü–í–ê –ß–ê–°–¢–ò–ù–ê) --- #}
                
                {% if document.is_posted %}
                    <button disabled class="btn btn-secondary" style="cursor: not-allowed;">
                        üîí –ü—Ä–æ–≤–µ–¥–µ–Ω–æ
                    </button>
                {% else %}
                    {# –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω—è —Ç—ñ–ª—å–∫–∏ –¥–ª—è –Ω–∞–∫–ª–∞–¥–Ω–∏—Ö #}
                    {% if document.operation_type in ['–ü—Ä–∏–±—É—Ç–∫–æ–≤–∞ –Ω–∞–∫–ª–∞–¥–Ω–∞', '–í–∏–¥–∞—Ç–∫–æ–≤–∞ –Ω–∞–∫–ª–∞–¥–Ω–∞'] %}
                        <form action="{{ url_for('post_document', doc_id=document.documents_id) }}" method="POST" style="display: inline;">
                            <button type="submit" class="btn btn-success" 
                                    onclick="return confirm('–ü—Ä–æ–≤–µ—Å—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç?')">
                                ‚úÖ –ü—Ä–æ–≤–µ—Å—Ç–∏
                            </button>
                        </form>
                    {% endif %}
                {% endif %}


                {# --- –ë–õ–û–ö 2: –ö–ù–û–ü–ö–ò "–°–¢–í–û–†–ò–¢–ò –ù–ê –ü–Ü–î–°–¢–ê–í–Ü" (–ü–†–ê–í–ê –ß–ê–°–¢–ò–ù–ê) --- #}

                {# –ê: –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è -> –†–∞—Ö—É–Ω–æ–∫ #}
                {% if document.operation_type == '–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è' %}
                    <a href="{{ url_for('create_invoice_based_on', source_id=document.documents_id) }}" 
                    class="btn btn-primary">
                    üìÑ –°—Ç–≤–æ—Ä–∏—Ç–∏ –†–∞—Ö—É–Ω–æ–∫
                    </a>

                {# –ë: –†–∞—Ö—É–Ω–æ–∫ -> –í–∏–¥–∞—Ç–∫–æ–≤–∞ #}
                {% elif document.operation_type == '–†–∞—Ö—É–Ω–æ–∫ —Ñ–∞–∫—Ç—É—Ä–∞' %}
                    <a href="{{ url_for('create_outgoing_based_on', source_id=document.documents_id) }}" 
                    class="btn btn-info text-white">
                    üì¶ –°—Ç–≤–æ—Ä–∏—Ç–∏ –í–∏–¥–∞—Ç–∫–æ–≤—É
                    </a>

                {# –í: –í–∏–¥–∞—Ç–∫–æ–≤–∞ -> –ü–æ–¥–∞—Ç–∫–æ–≤–∞ #}
                {% elif document.operation_type == '–í–∏–¥–∞—Ç–∫–æ–≤–∞ –Ω–∞–∫–ª–∞–¥–Ω–∞' %}
                    <a href="{{ url_for('create_tax_invoice_based_on', source_id=document.documents_id) }}" 
                    class="btn btn-warning">
                    üí∞ –°—Ç–≤–æ—Ä–∏—Ç–∏ –ü–æ–¥–∞—Ç–∫–æ–≤—É
                    </a>
                    
                {% endif %}

            </div>
        </div>

        <div style="margin-top: 30px; text-align: center;">
             <a href="{{ url_for('documents_list') }}">–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ —Å–ø–∏—Å–∫—É</a>
        </div>
    </div>
{% endblock %}